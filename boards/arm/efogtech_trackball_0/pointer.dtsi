#include <dt-bindings/zmk/p2sm.h>
#include <dt-bindings/zmk/paw3395-modes.h>
#include <input/processors/p2sm.dtsi>
#include <input/processors/axis_clamper.dtsi>
#include <input/processors/report_rate_limit.dtsi>
#include <input/processors/accel_curve.dtsi>
#include <input/processors/rotate_plane.dtsi>
#include <behaviors/p2sm_behaviors.dtsi>
#include <behaviors/rate_limit.dtsi>
#include <behaviors/auto_hold.dtsi>
#include <behaviors/switch_keymap.dtsi>

&zip_2s_mixer {
	status = "okay";
	sync-report-ms = <0>;

	sync-scroll-report-ms = <8>;
	twist-thres = <3>;
	twist-interference-thres = <200>;
	twist-interference-window = <8>;

	// arbitrary bounding box (0, 0, 0) - (255, 255, 255)
	ball-radius = <102>; // maximum = 127
	sensor1-pos = [31 4B 2D];  // X Y Z
	sensor2-pos = [C1 3C 2D];

	feedback-gpios = <&gpio0 24 GPIO_ACTIVE_HIGH>;
	feedback-extra-gpios = <&gpio1 0 GPIO_ACTIVE_HIGH>;
	twist-feedback-threshold = <20>;
	twist-feedback-delay = <8>;
	twist-feedback-duration = <50>;
};

&zip_rotate_pointer {
	timeout = <1>;
};

&zip_rotate_scroll {
	timeout = <8>;
};

/ {
	behaviors {
		skmp {
			feedback-gpios = <&gpio0 24 GPIO_ACTIVE_HIGH>;
			feedback-extra-gpios = <&gpio1 0 GPIO_ACTIVE_HIGH>;
			feedback-duration = <150>;
		};
	};
	
	trackball {
		compatible = "zmk,input-listener";
		device = <&zip_2s_mixer>;
		input-processors = <&zip_ble_report_rate_limit>;
	};

	rotated_pointer_plane {
		compatible = "zmk,input-listener";
		device = <&zip_rotate_pointer>;
		input-processors = <&zip_ble_report_rate_limit>;
	};

	rotated_scroll_plane {
		compatible = "zmk,input-listener";
		device = <&zip_rotate_scroll>;
		input-processors = <&zip_ble_report_rate_limit>;
	};

	trackball_primary_listener: trackball_primary_listener {
		compatible = "zmk,input-listener";
		device = <&trackball_primary>;
		input-processors = <&zip_2s_mixer INPUT_MIXER_SENSOR1>;
	};

	trackball_secondary_listener: trackball_secondary_listener {
		compatible = "zmk,input-listener";
		device = <&trackball_secondary>;
		input-processors = <&zip_2s_mixer INPUT_MIXER_SENSOR2>;
	};
};

&spi0 {
	status = "okay";
	compatible = "nordic,nrf-spim";
	pinctrl-0 = <&spi0_default>;
	pinctrl-1 = <&spi0_sleep>;
	pinctrl-names = "default", "sleep";
	cs-gpios = <&gpio0 30 (GPIO_ACTIVE_LOW)>;
	clock-frequency = <4000000>;

	trackball_primary: trackball_primary@0 {
		status = "okay";
		compatible = "pixart,paw3395";
		reg = <0>;
		spi-max-frequency = <4000000>;
		irq-gpios = <&gpio0 2 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
		cpi = <2400>;
		evt-type = <INPUT_EV_REL>;
		x-input-code = <INPUT_REL_X>;
		y-input-code = <INPUT_REL_Y>;
		power-mode = <PAW3395_OFFICE>;
		invert-x;
		invert-y;
	};
};

&spi1 {
	status = "okay";
	compatible = "nordic,nrf-spim";
	pinctrl-0 = <&spi1_default>;
	pinctrl-1 = <&spi1_sleep>;
	pinctrl-names = "default", "sleep";
	cs-gpios = <&gpio1 7 (GPIO_ACTIVE_LOW)>;
	clock-frequency = <4000000>;

	trackball_secondary: trackball_secondary@0 {
		status = "okay";
		compatible = "pixart,paw3395";
		reg = <0>;
		spi-max-frequency = <4000000>;
		irq-gpios = <&gpio1 4 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
		cpi = <2400>;
		evt-type = <INPUT_EV_REL>;
		x-input-code = <INPUT_REL_X>;
		y-input-code = <INPUT_REL_Y>;
		power-mode = <PAW3395_OFFICE>;
	};
};

/ {
	behaviors {
		rrl {
			feedback-gpios = <&gpio0 24 GPIO_ACTIVE_HIGH>;
			feedback-extra-gpios = <&gpio1 0 GPIO_ACTIVE_HIGH>;
			values-ms = <0 1 2 4 6 8>;
		};

		p2sm_sensitivity {
			feedback-gpios = <&gpio0 24 GPIO_ACTIVE_HIGH>;
			feedback-extra-gpios = <&gpio1 0 GPIO_ACTIVE_HIGH>;
		};

		p2sm_scroll_sensitivity {
			feedback-gpios = <&gpio0 24 GPIO_ACTIVE_HIGH>;
			feedback-extra-gpios = <&gpio1 0 GPIO_ACTIVE_HIGH>;
		};

		p2sm_sens_toggle {
			feedback-gpios = <&gpio0 24 GPIO_ACTIVE_HIGH>;
			feedback-extra-gpios = <&gpio1 0 GPIO_ACTIVE_HIGH>;
		};

		paw_cal1: paw_cal1 {
			status = "disabled";
			compatible = "zmk,behavior-paw3395-calibrate";
			#binding-cells = <0>;
			display-name = "Manual calibration of the left sensor";
			feedback-duration = <200>;
			feedback-gpios = <&gpio0 24 GPIO_ACTIVE_HIGH>;
			feedback-extra-gpios = <&gpio1 0 GPIO_ACTIVE_HIGH>;
			bindings = <&trackball_primary>;
		};

		paw_cal2: paw_cal2 {
			status = "disabled";
			compatible = "zmk,behavior-paw3395-calibrate";
			#binding-cells = <0>;
			display-name = "Manual calibration of the right sensor";
			feedback-duration = <200>;
			feedback-gpios = <&gpio0 24 GPIO_ACTIVE_HIGH>;
			feedback-extra-gpios = <&gpio1 0 GPIO_ACTIVE_HIGH>;
			bindings = <&trackball_secondary>;
		};

		paw_mode1: paw_mode1 {
			compatible = "zmk,behavior-paw3395-power-mode-toggle";
			#binding-cells = <2>;
			display-name = "Switch mode of the left sensor";
			feedback-duration = <200>;
			feedback-gpios = <&gpio0 24 GPIO_ACTIVE_HIGH>;
			feedback-extra-gpios = <&gpio1 0 GPIO_ACTIVE_HIGH>;
			bindings = <&trackball_primary>;
		};

		paw_mode2: paw_mode2 {
			compatible = "zmk,behavior-paw3395-power-mode-toggle";
			#binding-cells = <2>;
			display-name = "Switch mode of the right sensor";
			feedback-duration = <200>;
			feedback-gpios = <&gpio0 24 GPIO_ACTIVE_HIGH>;
			feedback-extra-gpios = <&gpio1 0 GPIO_ACTIVE_HIGH>;
			bindings = <&trackball_secondary>;
		};
	};
};
